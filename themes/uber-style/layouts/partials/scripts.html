{{ $js := resources.Get "js/main.js" }}
{{ if $js }}
{{ $js := $js | resources.Minify }}
<script src="{{ $js.RelPermalink }}"></script>
{{ end }}

<!-- Mermaid diagrams -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    mermaid.initialize({
        startOnLoad: false,
        theme: 'dark',
        themeVariables: {
            // Use original color scheme
            primaryColor: '#ff6b6b',
            primaryTextColor: '#ffffff',
            primaryBorderColor: '#ffffff',
            lineColor: '#ffffff',
            sectionBkgColor: '#2d3748',
            altSectionBkgColor: '#4a5568',
            gridColor: '#718096',
            secondaryColor: '#4ecdc4',
            tertiaryColor: '#45b7d1',
            // Edge/arrow styling
            edgeLabelBackground: '#2d3748',
            clusterBkg: '#4a5568',
            clusterBorder: '#ffffff'
        },
        flowchart: {
            nodeSpacing: 100,
            rankSpacing: 120,
            curve: 'basis',
            padding: 30
        },
        gitgraph: {
            theme: 'dark'
        },
        // Larger text and better scaling
        maxTextSize: 90000,
        maxWidth: 1400,
        fontSize: 20,
        fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif'
    });

    // Process Mermaid code blocks with a small delay to ensure DOM is ready
    setTimeout(function() {
        const mermaidElements = document.querySelectorAll('pre code.language-mermaid');
        console.log('Found', mermaidElements.length, 'mermaid elements');

        mermaidElements.forEach((element, index) => {
            // Get the raw text content
            let mermaidCode = element.textContent.trim();
            console.log('Processing mermaid code:', mermaidCode.substring(0, 50));

            // Create new mermaid div
            const mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.id = 'mermaid-' + index;

            // Set the mermaid code as text content
            mermaidDiv.textContent = mermaidCode;

            // Replace the pre element with the mermaid div
            const preElement = element.closest('pre');
            preElement.parentNode.replaceChild(mermaidDiv, preElement);
        });

        // Initialize and render mermaid diagrams
        if (mermaidElements.length > 0) {
            mermaid.run();

            // Add zoom functionality after rendering
            setTimeout(() => {
                addZoomToMermaidDiagrams();
            }, 500);
        }
    }, 100);

    // Add zoom functionality to Mermaid diagrams
    function addZoomToMermaidDiagrams() {
        const mermaidDivs = document.querySelectorAll('.mermaid');

        mermaidDivs.forEach((div, index) => {
            // Create zoom controls container
            const zoomContainer = document.createElement('div');
            zoomContainer.className = 'mermaid-zoom-controls';
            zoomContainer.innerHTML = `
                <button class="zoom-btn zoom-in" title="Zoom In">+</button>
                <button class="zoom-btn zoom-out" title="Zoom Out">−</button>
                <button class="zoom-btn zoom-reset" title="Reset Zoom">⌂</button>
            `;

            // Insert zoom controls before the diagram
            div.parentNode.insertBefore(zoomContainer, div);

            // Add zoom functionality
            let currentZoom = 1;
            const svg = div.querySelector('svg');

            if (svg) {
                const zoomIn = zoomContainer.querySelector('.zoom-in');
                const zoomOut = zoomContainer.querySelector('.zoom-out');
                const zoomReset = zoomContainer.querySelector('.zoom-reset');

                zoomIn.addEventListener('click', () => {
                    currentZoom = Math.min(currentZoom * 1.2, 3);
                    svg.style.transform = `scale(${currentZoom})`;
                    svg.style.transformOrigin = 'center center';
                });

                zoomOut.addEventListener('click', () => {
                    currentZoom = Math.max(currentZoom / 1.2, 0.5);
                    svg.style.transform = `scale(${currentZoom})`;
                    svg.style.transformOrigin = 'center center';
                });

                zoomReset.addEventListener('click', () => {
                    currentZoom = 1;
                    svg.style.transform = 'scale(1)';
                });

                // Add wheel zoom support
                div.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        currentZoom = Math.min(currentZoom * 1.1, 3);
                    } else {
                        currentZoom = Math.max(currentZoom / 1.1, 0.5);
                    }
                    svg.style.transform = `scale(${currentZoom})`;
                    svg.style.transformOrigin = 'center center';
                });
            }
        });
    }
});
</script>

<script>
// Simple search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchToggle = document.querySelector('.search__toggle');
    const searchOverlay = document.querySelector('.search__overlay');
    const searchClose = document.querySelector('.search__close');
    const searchInput = document.querySelector('.search__input');
    
    if (searchToggle && searchOverlay) {
        searchToggle.addEventListener('click', function() {
            searchOverlay.classList.add('search__overlay--open');
            searchInput.focus();
        });
        
        searchClose.addEventListener('click', function() {
            searchOverlay.classList.remove('search__overlay--open');
        });
        
        searchOverlay.addEventListener('click', function(e) {
            if (e.target === searchOverlay) {
                searchOverlay.classList.remove('search__overlay--open');
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchOverlay.classList.remove('search__overlay--open');
            }
        });
    }
});
</script>